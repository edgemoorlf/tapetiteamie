<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è¯­éŸ³äº¤äº’è§†é¢‘æ’­æ”¾å™¨</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Arial', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }

    .container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      max-width: 900px;
      width: 100%;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    h1 {
      text-align: center;
      color: #667eea;
      margin-bottom: 30px;
      font-size: 2em;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 15px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    video {
      width: 100%;
      display: block;
    }

    .voice-prompt {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.85);
      color: white;
      padding: 30px 40px;
      border-radius: 15px;
      text-align: center;
      display: none;
      z-index: 10;
    }

    .voice-prompt.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translate(-50%, -50%) scale(0.9); }
      to { opacity: 1; transform: translate(-50%, -50%) scale(1); }
    }

    .mic-icon {
      font-size: 48px;
      margin-bottom: 15px;
      animation: pulse 1.5s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.1); opacity: 0.8; }
    }

    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    button {
      flex: 1;
      padding: 12px 24px;
      border: none;
      border-radius: 10px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-size: 16px;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      min-width: 120px;
    }

    button:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    button:active {
      transform: translateY(0);
    }

    button:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .video-list {
      margin-top: 20px;
    }

    .video-list h3 {
      color: #667eea;
      margin-bottom: 15px;
    }

    .video-item {
      padding: 12px;
      background: #f5f5f5;
      margin-bottom: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .video-item:hover {
      background: #e0e0e0;
    }

    .video-item.active {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .status {
      text-align: center;
      padding: 15px;
      border-radius: 10px;
      margin-top: 15px;
      background: #f0f0f0;
      color: #666;
    }

    .status.listening {
      background: #fff3cd;
      color: #856404;
    }

    .status.processing {
      background: #d1ecf1;
      color: #0c5460;
    }

    .preload-info {
      font-size: 12px;
      color: #999;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ¬ è¯­éŸ³äº¤äº’è§†é¢‘æ’­æ”¾å™¨</h1>
    
    <div class="video-container">
      <video id="mainVideo" preload="auto"></video>
      <div id="voicePrompt" class="voice-prompt">
        <div class="mic-icon">ğŸ¤</div>
        <h2>è¯·è¯´å‡ºä½ æƒ³æ’­æ”¾çš„è§†é¢‘...</h2>
        <p>ä¾‹å¦‚ï¼š"è§†é¢‘1"ã€"ç¬¬äºŒä¸ª"</p>
      </div>
    </div>

    <div class="controls">
      <button id="playBtn">â–¶ æ’­æ”¾</button>
      <button id="pauseBtn">â¸ æš‚åœ</button>
      <button id="testVoiceBtn">ğŸ¤ æµ‹è¯•è¯­éŸ³</button>
    </div>

    <div id="status" class="status">å‡†å¤‡å°±ç»ª</div>

    <div class="video-list">
      <h3>ğŸ“¹ å¯ç”¨è§†é¢‘åˆ—è¡¨</h3>
      <div id="videoListContainer"></div>
      <div class="preload-info">* è§†é¢‘ä¼šåœ¨æ’­æ”¾å‰è‡ªåŠ¨é¢„åŠ è½½ä»¥ç¡®ä¿æµç•…åˆ‡æ¢</div>
    </div>
  </div>

  <script>
    class VoiceVideoPlayer {
      constructor() {
        this.mainVideo = document.getElementById('mainVideo');
        this.voicePrompt = document.getElementById('voicePrompt');
        this.status = document.getElementById('status');
        this.videoListContainer = document.getElementById('videoListContainer');
        
        this.videos = [];
        this.currentIndex = 0;
        this.preloadedVideos = new Map();
        this.isListening = false;
        this.mediaRecorder = null;
        this.audioChunks = [];
        
        this.init();
      }

      async init() {
        await this.loadVideos();
        this.setupEventListeners();
        this.preloadNextVideos();
      }

      async loadVideos() {
        try {
          const response = await fetch('/api/videos');
          this.videos = await response.json();
          
          if (this.videos.length === 0) {
            this.updateStatus('è¯·åœ¨ videos ç›®å½•ä¸­æ·»åŠ  mp4 è§†é¢‘æ–‡ä»¶');
            return;
          }
          
          this.renderVideoList();
          this.loadVideo(0);
          this.updateStatus(`å·²åŠ è½½ ${this.videos.length} ä¸ªè§†é¢‘`);
        } catch (error) {
          this.updateStatus('åŠ è½½è§†é¢‘åˆ—è¡¨å¤±è´¥: ' + error.message);
        }
      }

      renderVideoList() {
        this.videoListContainer.innerHTML = '';
        this.videos.forEach((video, index) => {
          const div = document.createElement('div');
          div.className = 'video-item';
          div.innerHTML = `
            <span>${index + 1}. ${video.name}</span>
            <span style="font-size: 12px; color: #999;">ç‚¹å‡»æ’­æ”¾</span>
          `;
          div.addEventListener('click', () => this.loadVideo(index));
          this.videoListContainer.appendChild(div);
        });
      }

      loadVideo(index) {
        if (index < 0 || index >= this.videos.length) return;
        
        this.currentIndex = index;
        const video = this.videos[index];
        
        // å¦‚æœå·²ç»é¢„åŠ è½½ï¼Œä½¿ç”¨é¢„åŠ è½½çš„è§†é¢‘
        if (this.preloadedVideos.has(index)) {
          this.mainVideo.src = this.preloadedVideos.get(index);
        } else {
          this.mainVideo.src = video.url;
        }
        
        this.mainVideo.load();
        this.updateVideoListUI();
        this.updateStatus(`æ­£åœ¨æ’­æ”¾: ${video.name}`);
        
        // é¢„åŠ è½½æ¥ä¸‹æ¥çš„è§†é¢‘
        this.preloadNextVideos();
      }

      preloadNextVideos() {
        // é¢„åŠ è½½æ¥ä¸‹æ¥çš„2ä¸ªè§†é¢‘
        for (let i = 1; i <= 2; i++) {
          const nextIndex = (this.currentIndex + i) % this.videos.length;
          if (!this.preloadedVideos.has(nextIndex)) {
            this.preloadVideo(nextIndex);
          }
        }
      }

      preloadVideo(index) {
        if (index < 0 || index >= this.videos.length) return;
        
        const video = this.videos[index];
        const preloadVideo = document.createElement('video');
        preloadVideo.preload = 'auto';
        preloadVideo.src = video.url;
        
        // å­˜å‚¨blob URLä»¥ä¾¿å¿«é€Ÿåˆ‡æ¢
        this.preloadedVideos.set(index, video.url);
        
        console.log(`é¢„åŠ è½½è§†é¢‘ ${index + 1}: ${video.name}`);
      }

      updateVideoListUI() {
        const items = this.videoListContainer.querySelectorAll('.video-item');
        items.forEach((item, index) => {
          item.classList.toggle('active', index === this.currentIndex);
        });
      }

      setupEventListeners() {
        // è§†é¢‘ç»“æŸæ—¶è§¦å‘è¯­éŸ³è¯†åˆ«
        this.mainVideo.addEventListener('ended', () => {
          this.showVoicePrompt();
          this.startVoiceRecognition();
        });

        // æ’­æ”¾æ§åˆ¶
        document.getElementById('playBtn').addEventListener('click', () => {
          this.mainVideo.play();
        });

        document.getElementById('pauseBtn').addEventListener('click', () => {
          this.mainVideo.pause();
        });

        document.getElementById('testVoiceBtn').addEventListener('click', () => {
          this.showVoicePrompt();
          this.startVoiceRecognition();
        });
      }

      showVoicePrompt() {
        this.voicePrompt.classList.add('active');
      }

      hideVoicePrompt() {
        this.voicePrompt.classList.remove('active');
      }

      async startVoiceRecognition() {
        if (this.isListening) return;
        
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          this.isListening = true;
          this.audioChunks = [];
          
          this.mediaRecorder = new MediaRecorder(stream);
          
          this.mediaRecorder.addEventListener('dataavailable', (event) => {
            this.audioChunks.push(event.data);
          });

          this.mediaRecorder.addEventListener('stop', async () => {
            const audioBlob = new Blob(this.audioChunks, { type: 'audio/webm' });
            await this.processVoice(audioBlob);
            
            stream.getTracks().forEach(track => track.stop());
            this.isListening = false;
          });

          this.mediaRecorder.start();
          this.updateStatus('ğŸ¤ æ­£åœ¨å¬...', 'listening');

          // 3ç§’ååœæ­¢å½•éŸ³
          setTimeout(() => {
            if (this.mediaRecorder && this.mediaRecorder.state === 'recording') {
              this.mediaRecorder.stop();
            }
          }, 3000);

        } catch (error) {
          this.updateStatus('éº¦å…‹é£è®¿é—®å¤±è´¥: ' + error.message);
          this.hideVoicePrompt();
        }
      }

      async processVoice(audioBlob) {
        this.updateStatus('ğŸ”„ æ­£åœ¨å¤„ç†è¯­éŸ³...', 'processing');
        
        try {
          // ä½¿ç”¨ FormData ä¸Šä¼ éŸ³é¢‘ï¼ˆPython æœåŠ¡å™¨æ”¯æŒï¼‰
          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.webm');

          const response = await fetch('/api/speech-to-text', {
            method: 'POST',
            body: formData
          });

          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || errorData.error || 'è¯­éŸ³è¯†åˆ«å¤±è´¥');
          }

          const result = await response.json();
          console.log('API è¿”å›ç»“æœ:', result);
          
          // å®‰å…¨åœ°å¤„ç† transcript
          const transcript = result.transcript ? result.transcript.trim().toLowerCase() : '';
          
          if (!transcript) {
            this.updateStatus('âš ï¸ æœªèƒ½è¯†åˆ«è¯­éŸ³å†…å®¹ï¼Œè¯·é‡è¯•æˆ–æ’­æ”¾ä¸‹ä¸€ä¸ª');
            this.hideVoicePrompt();
            setTimeout(() => {
              this.playNext();
            }, 2000);
            return;
          }

          this.updateStatus(`âœ… è¯†åˆ«ç»“æœ: "${transcript}"`);
          this.hideVoicePrompt();
          
          // åŒ¹é…è§†é¢‘
          const videoIndex = this.matchVideo(transcript);
          if (videoIndex !== -1) {
            setTimeout(() => {
              this.loadVideo(videoIndex);
              this.mainVideo.play();
            }, 1000);
          } else {
            this.updateStatus(`æœªæ‰¾åˆ°åŒ¹é…çš„è§†é¢‘ "${transcript}"ï¼Œæ’­æ”¾ä¸‹ä¸€ä¸ª`);
            setTimeout(() => {
              this.playNext();
            }, 2000);
          }
        } catch (error) {
          console.error('è¯­éŸ³å¤„ç†é”™è¯¯:', error);
          this.updateStatus('âŒ è¯­éŸ³å¤„ç†å¤±è´¥: ' + error.message);
          this.hideVoicePrompt();
          
          // å¤±è´¥åæ’­æ”¾ä¸‹ä¸€ä¸ªè§†é¢‘
          setTimeout(() => {
            this.playNext();
          }, 2000);
        }
      }

      matchVideo(transcript) {
        // åŒ¹é…é€»è¾‘ï¼šæ”¯æŒ"è§†é¢‘1"ã€"ç¬¬ä¸€ä¸ª"ã€"1"ç­‰è¡¨è¾¾
        for (let i = 0; i < this.videos.length; i++) {
          const videoName = this.videos[i].name.toLowerCase();
          const index = i + 1;
          
          if (transcript.includes(videoName) ||
              transcript.includes(`è§†é¢‘${index}`) ||
              transcript.includes(`ç¬¬${this.numberToChinese(index)}ä¸ª`) ||
              transcript === `${index}`) {
            return i;
          }
        }
        return -1;
      }

      numberToChinese(num) {
        const chinese = ['ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­', 'ä¸ƒ', 'å…«', 'ä¹', 'å'];
        return chinese[num - 1] || num.toString();
      }

      playNext() {
        const nextIndex = (this.currentIndex + 1) % this.videos.length;
        this.loadVideo(nextIndex);
        this.mainVideo.play();
      }

      updateStatus(message, className = '') {
        this.status.textContent = message;
        this.status.className = 'status ' + className;
      }
    }

    // åˆå§‹åŒ–æ’­æ”¾å™¨
    const player = new VoiceVideoPlayer();
  </script>
</body>
</html>